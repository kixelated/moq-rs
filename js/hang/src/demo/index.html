<!doctype html>
<html lang="en" class="dark">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MoQ Demo</title>

	<link rel="stylesheet" href="index.css">
	<link rel="icon" type="image/svg+xml" href="/favicon.svg">
</head>

<body>
	<!-- Show if this browser supports everything we need. -->
	<hang-support role="watch"></hang-support>

	<!-- There's a simple, web component to set up the provided canvas, including some basic controls. -->
	<hang-watch url="http://localhost:4443/demo/bbb.hang" muted controls>
		<canvas style="max-width: 100%; height: auto; border-radius: 4px; margin: 0 auto;"></canvas>
	</hang-watch>

	<h3>Other demos:</h3>
	<ul>
		<li><a href="publish.html">Publish a broadcast.</a></li>
		<li><a href="announce.html">List all active broadcasts.</a></li>
	</ul>

	<h3>Tips:</h3>
	<p>
		You can instanciate the player via the provided <code class="language-html">&lt;hang-watch&gt;</code> <a
			href="https://developer.mozilla.org/en-US/docs/Web/API/Web_components">Web Component</a>.
		Either modify HTML attributes like <code class="language-html">&lt;hang-watch paused&gt;</code> or use the
		Javascript API.
	</p>
	<p>
		You can provide your own canvas element and use CSS to modify it.
		Unfortunately, you can't use the HTML width/height attributes because of how <a
			href="https://developer.mozilla.org/en-US/docs/Web/API/OffscreenCanvas">OffscreenCanvas</a>
		works.
		For example:
	<pre><code class="language-html">&lt;hang-watch url=&quot;http://localhost:4443/&quot; room=&quot;demo&quot; name=&quot;bbb&quot;&gt;
	&lt;!-- Optionally provide a custom canvas element that we can style as needed --&gt;
	&lt;canvas style=&quot;max-width: 100%; height: auto; border-radius: 4px;&quot;&gt;&lt;/canvas&gt;
&lt;/hang-watch&gt;</code></pre>
	</p>
	<p>
		Don't want video? Don't provide a canvas!
		It won't be downloaded, decoded, or rendered.
		This includes when the video is paused, minimized, not in the DOM, or scrolled out of view.
		wowee the bandwidth savings!
	</p>
	<p>
		Audio may start muted because the browser can require user interaction before autoplaying.
		You can unmute it by changing the volume or calling <code
			class="language-typescript">watch.audio.enabled.set(true)</code> via the Javascript API.
		And of course, nothing is downloaded while it's muted.
	</p>
	<hr>
	<hr />
	<p>
		The Javascript API is far more powerful and you can access properties directly:

	<pre><code class="language-typescript">const watch = document.getElementById("watch");
watch.paused.set(true);
</code></pre>
	</p>

	<p>
		All of the properties are reactive using <a href="https://solidjs.com/">SolidJS</a> signals.
		That means if you use SolidJS (try it, it's better than React), you can do things like this:

	<pre><code class="language-typescript">
import { createMemo } from "solid-js";
import { Watch } from "@kixelated/hang";

function Volume(hang: Watch) {
	// Compute the volume based on the watch's muted and volume signals.
	const volume = createMemo(() => (hang.muted.get() ? 0 : hang.volume.get()));

	// Return a div that displays the volume.
	return &lt;div&gt;
		Volume: {volume.get()}
	&lt;/div&gt;
}
		</code></pre>
	</p>

	<p>
		But the demo doesn't use SolidJS on purpose to show that it's not required.
		You can use the handy <code class="language-typescript">subscribe()</code> method to trigger a callback instead:

	<pre><code class="language-typescript">
// There's also a `derived` method that is just a wrapper around SolidJS's `createMemo`.
const volume = hang.muted.derived((muted) => (muted ? 0 : hang.volume.get()));

const cleanup = volume.subscribe((volume) => {
	// Update the volume display.
	document.getElementById("volume-value").textContent = `${volume * 100}%`;
});

// Cleanup the subscription when no longer needed.
cleanup();
		</code></pre>
	</p>
	<hr>
	<p>
		The connection and broadcast are automatically reloaded.
		Try running multiple terminals and kill the broadcast to see what happens.

	<pre><code class="language-bash"># Run the relay and web server in another terminal or the background.
just relay &
just web &

just pub bbb
# Kill it with ctrl+C

# Republish the same broadcast, the player will reconnect.
just pub bbb
		</code></pre>
	</p>
	<p>
		If the Big Bunny is making you sick, you can use other inferior test videos or the <a
			href="publish.html">publish demo</a>.
		For example,
		Try running <code class="language-bash">just pub tos</code> in a new terminal and then <a
			href="index.html?name=demo/tos" target="_blank">watch robots bang</a>.
		This command uses ffmpeg to produce a fragmented MP4 file piped over stdout and then sent over the network.
		Yeah it's pretty gross.
	</p>
	<p>
		If you want to do things more efficiently, you can use the <i>alpha</i> gstreamer plugin via:
		<code class="language-bash">just pub-gst tos</code>.
		It's pretty crude and doesn't handle all pipeline events; contributions welcome!
	</p>
	<p>
		And if you're feeing extra adventurous, use <code class="language-bash">just sub-gst tos</code> to <i>watch</i>
		via gstreamer.
	</p>
	<hr />
	<p>
		This demo uses `http://` so it's not secure.
		It works by fetching the certificate hash (via HTTP) and providing that to WebTransport, which requires HTTPS.
		To run this in production, you'll need a valid certificate (ex. letsencrypt) and to use `https://`.
	</p>
</body>

<script type="module" src="index.ts"></script>

</html>